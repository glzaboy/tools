#!/bin/sh
if [ $# -eq 0 ]
then
	echo "Usage: $0 -p project [-r] [-d JMXPORT]"
	exit 1
fi
while getopts  :p:rd: OPTION; do

    case $OPTION in
        p)
            PROJECT=$(echo "$OPTARG" | sed 's/\.git$//');
        ;;
        r)
            RESET="1";
        ;;
            
        d)
            JMXPORT=$OPTARG;
            if [[ $JMXPORT -le 0 ]] ; then
                echo "DEBUG port invalid."
                exit;
            fi
        ;;
        ?)
            echo "illegal option $OPTION $OPTARG"
            exit 1;;

    esac;
done

PROJECTFIXED="${PROJECT}.git"

ROOT_PATH=$(env|grep HOME|awk -F '='   '{print $2}')"/software/buildjava"

echo "工作目录${ROOT_PATH}"

if [[ ! -d "$ROOT_PATH/$PROJECTFIXED" ]] ; then
	mkdir -p "$ROOT_PATH/$PROJECTFIXED"
	cd "$ROOT_PATH/$PROJECTFIXED"
	git clone "ssh://git@git.crudelion.com:822/glzaboy/${PROJECTFIXED}" ./
fi

if [[ ! -f "$ROOT_PATH/$PROJECTFIXED/pom.xml" ]] ;then
    echo "项目不存在,删除check文件"
    rm -frv "$ROOT_PATH/$PROJECTFIXED"
    exit;
fi

echo "切换到目录$ROOT_PATH/$PROJECTFIXED"

cd "$ROOT_PATH/$PROJECTFIXED"
echo "更新项目"
git pull -p
git submodule init
git submodule update

if [[ $RESET == "1" ]] ; then
        echo "清理项目"
        mvn clean
fi
if [[ -f "$ROOT_PATH/$PROJECTFIXED/project.properties" ]] ; then
    INSTALL=$(cat project.properties|awk -F "=" '{print $2}')
else
    INSTALL=0;
fi

if [[ $INSTALL  == 1 ]] ; then
    echo "安装到maven"
    mvn install
else
    echo "运行java"
    PIDINFO=`/usr/bin/jps -l | /usr/bin/grep $PROJECT`
    PID=`echo ${PIDINFO}|awk '{print $1}'`
    echo "停止原来项目PID ${PID}"
    /usr/bin/kill  $PID
    echo "编译项目"
    mvn package
    cd target
    if [[ $JMXPORT -gt 0 ]] ;then
        if [[ `netstat -tnl|grep $JMXPORT|wc -l` -gt 0 ]] ; then
            echo "在端口${JMXPORT}上启动调试失败，以常规方式启动"
            /usr/bin/nohup /usr/bin/java -jar -Dspring.cloud.config.profile=prod  $PROJECT.jar >/dev/null 2>&1 &
        else
            /usr/bin/nohup /usr/bin/java -Dcom.sun.management.jmxremote.port=$JMXPORT -Dcom.sun.management.jmxremote.ssl=false -Dcom.sun.management.jmxremote.authenticate=false -jar -Dspring.cloud.config.profile=prod  $PROJECT.jar >/dev/null 2>&1 &
        fi
    else
            /usr/bin/nohup /usr/bin/java -jar -Dspring.cloud.config.profile=prod  $PROJECT.jar >/dev/null 2>&1 &
    fi
    #str=$"\n"
    #sstr=$(echo -e $str)
    #echo $sstr
    #tail -f nohup.out
fi
